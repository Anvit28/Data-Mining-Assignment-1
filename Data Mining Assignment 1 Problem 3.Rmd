---
title: "Data Mining Assignment 1 Problem 3"
author: ""
date: ""
output: 
  pdf_document: default
  md_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Problem 3

We filtered the data to make two separate datasets with  trim levels equal to 350 and 65 AMG. We split each dataset into training and testing sets, where 80% of observations are in training set. We run KNN models for all values of K from 2 to 200, and calculated corresponding RMSE.

```{r echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
library(tidyverse)
library(rsample)  
library(caret)
library(modelr)
library(parallel)
library(foreach)


sclass <- read.csv("sclass.csv", sep = ",", dec = ".")

# TRIM LEVEL = 350

set.seed(125)

#filtered for trim level = 350
trim350 <- filter(sclass, trim == "350")

#made a train-test split
trim350_split = initial_split(trim350, prop = 0.8)
trim350_train = training(trim350_split)
trim350_test = testing(trim350_split)

#took following values of K:
K_values <- c(2:200)
RMSE <- c()

for (i in K_values){
  #run KNN models
  knn = knnreg(price ~ mileage, data=trim350_train, k=i)
  #made a vector of RMSE values
  e <- modelr::rmse(knn, trim350_test)
  RMSE <- c(RMSE,e)
  #added to the testing set predictions for each value of K 
  new <- predict(knn, trim350_test)
  trim350_test[ , ncol(trim350_test) + 1] <- new
  colnames(trim350_test)[ncol(trim350_test)] <- paste0("price_pred_knn", i)
}

#made a plot of RMSE versus K
dataframe <- data.frame(K_values, RMSE) 
ggplot(dataframe) +
  geom_line(aes(x=K_values, y=RMSE)) +
  xlab("Values of K") + ylab("RMSE") + 
  ggtitle("Plot of RMSE versus K for trim=350")

#found optimal value of K
minimum <- min(dataframe$RMSE)
K <- K_values[dataframe$RMSE == minimum]
```

Figure 1. This plot shows the values of RMSE corresponding to different values of K for the dataset with trim level = 350. The minimum value of RMSE is reached when K is equal to 16.

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.height = 6}
knn = knnreg(price ~ mileage, data=trim350_train, k=K)
trim350 = trim350 %>%
  mutate(trim_pred = predict(knn, trim350))
ggplot(trim350) +
  geom_line(aes(x=mileage, y=trim_pred), color = "red") +
  geom_point((aes(x=mileage, y=price))) +
  xlab("mileage") + ylab("Fitted values of price") + 
  ggtitle("Plot of the fitted model")
```

Figure 2. Red line shows the fitted values of price corresponding to different values of mileage for the optimal value of K=16 (for the dataset with trim level = 350).

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.height = 6}
set.seed(125)

#filtered for trim level = 65 AMG
trim65AMG <- filter(sclass, trim == "65 AMG")

#made a train-test split
trim65AMG_split = initial_split(trim65AMG, prop = 0.8)
trim65AMG_train = training(trim65AMG_split)
trim65AMG_test = testing(trim65AMG_split)

#took following values of K:
K_values <- c(2:200)
RMSE <- c()

for (i in K_values){
  #run KNN models
  knn = knnreg(price ~ mileage, data=trim65AMG_train, k=i)
  #made a vector of RMSE values
  e <- modelr::rmse(knn, trim65AMG_test)
  RMSE <- c(RMSE,e)
  #added to the testing set predictions for each value of K 
  new <- predict(knn, trim65AMG_test)
  trim65AMG_test[ , ncol(trim65AMG_test) + 1] <- new
  colnames(trim65AMG_test)[ncol(trim65AMG_test)] <- paste0("price_pred_knn", i)
}

#made a plot of RMSE versus K
dataframe <- data.frame(K_values, RMSE) 
ggplot(dataframe) +
  geom_line(aes(x=K_values, y=RMSE)) +
  xlab("Values of K") + ylab("RMSE") + 
  ggtitle("Plot of RMSE versus K for trim=65 AMG")

#found optimal value of K
minimum <- min(dataframe$RMSE)
K <- K_values[dataframe$RMSE == minimum]
```

Figure 3. This plot shows the values of RMSE corresponding to different values of K for the dataset with trim level = 65 AMG. The minimum value of RMSE is reached when K is equal to 12.

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.height = 6}
#made a plot of of the predictions of price versus mileage
knn = knnreg(price ~ mileage, data=trim65AMG_train, k=K)
trim65AMG = trim65AMG %>%
  mutate(trim_pred = predict(knn, trim65AMG))
ggplot(trim65AMG) +
  geom_line(aes(x=mileage, y=trim_pred), color = "red") +
  geom_point((aes(x=mileage, y=price))) +
  xlab("mileage") + ylab("Fitted values of price") + 
  ggtitle("Plot of the fitted model")
```

Figure 4. Red line shows the fitted values of price corresponding to different values of mileage for the optimal value of K=12 (for the dataset with trim level = 65 AMG).


Taking different training and testing sets repeatedly from initial datasets, we will get larger optimal values of K from the dataset with trim = 350 more often than from the dataset with trim = 65 AMG.This could happen because the observations in the dataset with trim = 65 AMG are more scattered from each other, so we need smaller value of K to make prediction less biased.





